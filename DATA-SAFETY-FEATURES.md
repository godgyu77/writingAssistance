# 데이터 안전성 강화 완료 ✅

## 구현된 기능

### 1️⃣ 버전 관리 (Time Machine)

#### 📋 Versions 테이블
- **테이블 구조**:
  - `id`, `chapter_id`, `project_id`, `title`, `content`, `word_count`
  - `snapshot_type`: 'manual', 'auto', 'pre_ai', 'backup'
  - `created_at`
- **RLS 정책**: 프로젝트 소유자만 접근 가능
- **자동 정리**: 챕터당 최근 50개 버전만 유지

#### 💾 버전 저장 시점
1. **수동 저장** (`manual`): 툴바의 "버전 저장" 버튼 클릭 시
2. **자동 저장** (`auto`): 30분마다 자동으로 저장
3. **AI 실행 전** (`pre_ai`): AI 도구 실행 직전에 자동 저장
4. **백업** (`backup`): 필요 시 추가 백업

#### 🔍 버전 히스토리 모달
- **위치**: 우측 사이드바 → 히스토리 탭 → "버전 기록 보기" 버튼
- **기능**:
  - 왼쪽: 버전 리스트 (타입별 배지, 날짜, 글자 수)
  - 오른쪽: 선택된 버전 미리보기
  - 각 버전마다 "복원" 및 "삭제" 버튼
- **버전 복원**: 선택한 버전을 현재 에디터에 즉시 로드

### 2️⃣ 로컬 스토리지 백업 (IndexedDB)

#### 🗄️ IndexedDB 구조
- **라이브러리**: Dexie
- **테이블**:
  1. `chapters`: 챕터 전체 데이터
     - `id`, `projectId`, `title`, `content`, `wordCount`
     - `lastModified`, `syncedAt`, `needsSync`
  2. `drafts`: 실시간 임시 저장
     - `chapterId`, `content`, `title`, `timestamp`

#### ⚡ 실시간 백업
- **자동 저장**: 타이핑 멈춘 후 1초마다 로컬에 자동 저장
- **서버 저장**: 3초 debounce 후 Supabase에 저장
- **이중 보호**: 로컬과 서버 동시 백업으로 데이터 손실 방지

#### 🔌 오프라인 모드
- **자동 감지**: 인터넷 연결 끊어지면 즉시 감지
- **오프라인 배지**: 툴바 상단에 빨간색 "오프라인" 배지 표시
- **로컬 저장**: 오프라인 중에는 로컬 DB에만 저장
- **Toast 알림**: "오프라인 모드 - 로컬에 자동 저장됩니다"

#### 🔄 자동 동기화
- **연결 복구 감지**: 온라인 상태로 돌아오면 자동 감지
- **자동 업로드**: 동기화 안 된 로컬 데이터를 서버로 자동 전송
- **충돌 방지**: 서버와 로컬 타임스탬프 비교하여 최신 데이터 유지
- **Toast 알림**: "동기화 완료 - 로컬 데이터가 서버와 동기화되었습니다"

#### 📥 Draft 복구
- **자동 복구**: 앱 재시작 시 로컬 Draft가 서버보다 최신이면 자동 복구
- **알림**: "Draft 복구 - 저장되지 않은 로컬 데이터를 복구했습니다"

## 📁 새로 추가/수정된 파일

### 📄 새 파일
1. **`supabase-versions-schema.sql`**
   - versions 테이블 스키마
   - RLS 정책
   - 자동 정리 함수

2. **`lib/db/localDB.ts`**
   - Dexie DB 클래스 정의
   - IndexedDB 유틸리티 함수들
   - chapters, drafts 테이블 관리

3. **`lib/sync/syncManager.ts`**
   - 로컬 ↔ Supabase 동기화 로직
   - 충돌 감지 및 해결
   - 자동 동기화 함수

4. **`hooks/useOnlineStatus.ts`**
   - 온라인/오프라인 상태 감지 훅
   - 실시간 네트워크 상태 모니터링

5. **`components/VersionHistoryModal.tsx`**
   - 버전 히스토리 UI 모달
   - 버전 목록, 미리보기, 복원, 삭제 기능

### 🔄 수정된 파일
1. **`lib/types/database.ts`**
   - `Version` 인터페이스 추가

2. **`components/RightSidebar.tsx`**
   - "버전 기록 보기" 버튼 추가 (히스토리 탭)
   - `onBeforeAI` prop 추가 및 처리

3. **`app/studio/[id]/page.tsx`** (대폭 업데이트)
   - 버전 저장 함수 (`saveVersion`)
   - 버전 복원 함수 (`handleRestoreVersion`)
   - 로컬 백업 함수 (`saveToLocal`)
   - 오프라인 감지 및 Toast 알림
   - 자동 동기화 로직
   - 실시간 로컬 백업 (1초 debounce)
   - 챕터 로드 시 Draft 복구
   - 자동 저장에 버전 저장 추가 (30분마다)
   - 툴바에 오프라인 배지 및 버전 저장 버튼
   - 버전 히스토리 모달 통합
   - AI 실행 전 버전 저장

## 🚀 사용 방법

### 1. Supabase 테이블 생성
```sql
-- Supabase SQL Editor에서 실행
-- supabase-versions-schema.sql 파일의 내용 복사/실행
```

### 2. 버전 관리 사용법

#### 수동 버전 저장
1. 툴바에서 "버전 저장" 버튼 클릭
2. 현재 내용이 버전으로 저장됨
3. Toast 알림: "버전 저장 완료"

#### 자동 버전 저장
- 30분마다 자동으로 백그라운드에서 저장
- 별도 알림 없음

#### AI 실행 전 자동 저장
- AI 도구 실행 시 자동으로 현재 버전 저장
- 별도 알림 없음

#### 버전 복원
1. 우측 사이드바 → "히스토리" 탭
2. "버전 기록 보기" 버튼 클릭
3. 왼쪽에서 복원할 버전 선택
4. 오른쪽에서 내용 확인
5. "이 버전으로 복원" 버튼 클릭
6. 현재 에디터에 즉시 로드됨

### 3. 오프라인 모드 사용법

#### 자동 동작
- 인터넷 연결이 끊어지면 자동으로 오프라인 모드 진입
- 툴바에 빨간색 "오프라인" 배지 표시
- 모든 변경 사항이 로컬 DB에 자동 저장

#### 연결 복구 시
- 온라인 상태로 돌아오면 자동 감지
- "동기화 중..." Toast 표시
- 로컬 데이터를 서버로 자동 업로드
- "동기화 완료" Toast 표시

#### Draft 복구
- 앱 재시작 또는 페이지 새로고침 시
- 로컬 Draft가 서버보다 최신이면 자동 복구
- "Draft 복구" Toast 표시

## 🔧 기술 세부사항

### 버전 저장 전략
- **Manual**: 사용자가 명시적으로 요청
- **Auto**: 30분 간격 자동 저장 (마지막 자동 저장 시간 추적)
- **Pre-AI**: AI 실행 직전, 변경 전 상태 보존
- **Backup**: 추가적인 안전 백업용

### 로컬 저장 우선순위
1. **즉시**: Draft (1초 debounce)
2. **빠름**: LocalChapter (1초 debounce)
3. **보통**: Supabase (3초 debounce)
4. **느림**: 버전 (30분)

### 동기화 충돌 해결
- 타임스탬프 비교
- 로컬이 최신이고 `needsSync=true`이면 로컬 우선
- 그 외에는 서버 데이터 우선

### IndexedDB 정리
- 7일 이상 된 Draft 자동 삭제
- 로그아웃 시 모든 로컬 데이터 삭제 옵션

## ⚠️ 주의사항

1. **브라우저 호환성**
   - IndexedDB 지원 브라우저 필요
   - 대부분의 모던 브라우저 지원

2. **저장 용량**
   - 브라우저마다 IndexedDB 용량 제한 상이
   - 일반적으로 수백 MB 이상 지원

3. **다중 탭**
   - 여러 탭에서 동시 편집 시 마지막 저장이 우선
   - 가능하면 하나의 탭에서만 작업 권장

4. **버전 관리**
   - 챕터당 최근 50개 버전만 유지
   - 오래된 버전은 자동 삭제됨

## 🎯 테스트 시나리오

### 시나리오 1: 정상 동작
1. 에디터에서 글 작성
2. 자동 저장 확인 (3초 후)
3. "버전 저장" 버튼으로 수동 저장
4. 버전 히스토리에서 확인

### 시나리오 2: 오프라인
1. 네트워크 끊기 (개발자 도구 → Network → Offline)
2. 오프라인 배지 확인
3. 글 작성 계속
4. 네트워크 복구
5. 자동 동기화 확인

### 시나리오 3: Draft 복구
1. 글 작성 중
2. 저장 전에 브라우저 강제 종료
3. 앱 재시작
4. Draft 자동 복구 확인

### 시나리오 4: AI 실행 전 버전 저장
1. 글 작성
2. AI 도구 실행
3. 버전 히스토리에서 'pre_ai' 타입 버전 확인
4. AI 결과가 마음에 안 들면 이전 버전으로 복원

### 시나리오 5: 버전 복원
1. 버전 히스토리 열기
2. 과거 버전 선택
3. 미리보기 확인
4. 복원 실행
5. 에디터에 이전 내용 로드 확인

## 📊 성능 최적화

- **Debounce**: 1초, 3초 단계별 저장으로 서버 부하 최소화
- **Local First**: 로컬 저장 우선으로 즉각적인 응답성
- **Incremental Sync**: 변경된 데이터만 동기화
- **Background Tasks**: 버전 저장, 동기화는 백그라운드 처리

## 🛡️ 데이터 보호

- **3중 보호**: Draft (1초) → Supabase (3초) → Version (30분)
- **오프라인 대응**: 네트워크 끊어져도 데이터 손실 없음
- **충돌 해결**: 자동 감지 및 최신 데이터 유지
- **복구 기능**: Draft 자동 복구, 버전 히스토리

---

모든 기능이 정상적으로 구현되었습니다! 🎉
